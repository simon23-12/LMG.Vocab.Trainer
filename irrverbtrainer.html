
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LMG Irregular Verbs Trainer</title>
  
  <!-- PWA Support -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0066CC">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="LMG Vocab">
  <link rel="apple-touch-icon" href="/images/icons/icon-180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/images/icons/icon-192.png">
  
  <style>
    :root {
      --bg-gradient-start: #667eea;
      --bg-gradient-end: #764ba2;
      --container-bg: white;
      --text-primary: #333;
      --text-secondary: #666;
      --text-tertiary: #999;
      --border-color: #ddd;
      --input-bg: white;
      --input-border: #ddd;
      --button-primary: #667eea;
      --button-hover: #5568d3;
      --card-bg: white;
      --shadow-color: rgba(0,0,0,0.1);
      --overlay-bg: rgba(0,0,0,0.5);
    }

    body.dark-mode {
      --bg-gradient-start: #1a1a2e;
      --bg-gradient-end: #16213e;
      --container-bg: #0f3460;
      --text-primary: #e0e0e0;
      --text-secondary: #b0b0b0;
      --text-tertiary: #808080;
      --border-color: #2a2a3e;
      --input-bg: #1a1a2e;
      --input-border: #2a2a3e;
      --button-primary: #667eea;
      --button-hover: #5568d3;
      --card-bg: #16213e;
      --shadow-color: rgba(0,0,0,0.5);
      --overlay-bg: rgba(0,0,0,0.8);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      min-height: 100vh;
      padding: 20px;
      transition: background 0.3s ease;
    }
    
    .dark-mode-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255,255,255,0.3);
      transition: 0.3s;
      border-radius: 30px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .toggle-slider:before {
      position: absolute;
      content: "‚òÄÔ∏è";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    input:checked + .toggle-slider {
      background-color: #667eea;
    }

    input:checked + .toggle-slider:before {
      transform: translateX(30px);
      content: "üåô";
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--container-bg);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px var(--shadow-color);
      transition: background 0.3s ease, box-shadow 0.3s ease;
    }

    h1 { 
      color: var(--button-primary); 
      margin-bottom: 30px;
      text-align: center;
      font-size: 2.5em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .back-button {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 10px 20px;
      background: var(--button-primary);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .back-button:hover {
      background: var(--button-hover);
      transform: translateY(-2px);
    }

    .screen { display: none; }
    .screen.active { display: block !important; }

    .mode-selector {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 600px;
      margin: 40px auto;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .stat-card {
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      border-radius: 15px;
      padding: 30px;
      text-align: center;
      transition: all 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(102,126,234,0.2);
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-value {
      font-size: 48px;
      font-weight: bold;
      color: var(--button-primary);
      margin: 15px 0;
    }

    .stat-description {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-top: 10px;
    }

    .mode-selector {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 600px;
      margin: 40px auto;
    }

    .mode-card {
      padding: 30px;
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .mode-card:hover {
      border-color: var(--button-primary);
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(102,126,234,0.3);
    }

    .mode-title {
      font-size: 24px;
      font-weight: bold;
      color: var(--text-primary);
      margin-bottom: 10px;
    }

    .mode-description {
      font-size: 16px;
      color: var(--text-secondary);
    }

    .quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: var(--card-bg);
      border-radius: 10px;
      margin-bottom: 30px;
      border: 1px solid var(--border-color);
      transition: background 0.3s ease;
    }

    .progress {
      font-size: 18px;
      font-weight: 600;
      color: var(--button-primary);
    }

    .timer {
      font-size: 32px;
      font-weight: bold;
      color: var(--text-primary);
      min-width: 60px;
      text-align: center;
    }

    .timer.warning {
      color: #e74c3c;
      animation: pulse 0.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .question-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 60px 40px;
      border-radius: 20px;
      text-align: center;
      margin: 40px 0;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .question-word {
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 20px;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .question-label {
      font-size: 20px;
      opacity: 0.9;
      margin-bottom: 10px;
    }

    .answer-inputs {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 600px;
      margin: 30px auto;
    }

    .answer-input-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .answer-label {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-secondary);
      text-align: left;
    }

    .answer-input {
      width: 100%;
      padding: 20px;
      font-size: 24px;
      text-align: center;
      border: 3px solid var(--button-primary);
      border-radius: 12px;
      background: var(--input-bg);
      color: var(--text-primary);
      transition: background 0.3s ease, border 0.3s ease;
    }

    .answer-input:focus {
      outline: none;
      border-color: var(--button-hover);
      box-shadow: 0 0 0 3px rgba(102,126,234,0.2);
    }

    .feedback {
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      font-size: 18px;
      font-weight: 600;
      text-align: center;
    }

    .feedback.correct {
      background: #d4edda;
      color: #155724;
    }

    .feedback.wrong {
      background: #f8d7da;
      color: #721c24;
    }

    .score-display {
      text-align: center;
      margin: 40px 0;
    }

    .score-circle {
      width: 200px;
      height: 200px;
      margin: 0 auto 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 64px;
      font-weight: bold;
      color: white;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .score-text {
      font-size: 24px;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    .results-list {
      margin: 30px 0;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    .result-item {
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
    }

    .result-item.correct {
      background: #d4edda;
      border-color: #155724;
    }

    .result-item.wrong {
      background: #f8d7da;
      border-color: #721c24;
    }

    .result-verb {
      font-weight: 600;
      font-size: 18px;
      color: var(--text-primary);
      margin-bottom: 5px;
    }

    .result-answers {
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    button {
      padding: 12px 30px;
      background: var(--button-primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 5px;
      transition: all 0.3s;
    }

    button:hover {
      background: var(--button-hover);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102,126,234,0.4);
    }

    button:disabled {
      background: var(--text-tertiary);
      cursor: not-allowed;
      transform: none;
    }

    .footer {
      text-align: center;
      margin-top: 40px;
      padding: 20px;
      font-size: 12px;
      color: var(--text-tertiary);
      font-style: italic;
    }

    /* Mobile Optimierungen */
    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      h1 {
        font-size: 1.8em;
      }
      h2 {
        font-size: 1.3em;
      }
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      .stat-value {
        font-size: 36px;
      }
      .mode-selector {
        gap: 15px;
      }
      .mode-card {
        padding: 20px;
      }
      .mode-title {
        font-size: 20px;
      }
      .question-card {
        padding: 40px 20px;
      }
      .question-word {
        font-size: 32px;
      }
      .question-label {
        font-size: 16px;
      }
      .answer-input {
        font-size: 18px;
        padding: 15px;
      }
      .answer-label {
        font-size: 14px;
      }
      button {
        padding: 10px 20px;
        font-size: 14px;
      }
      .score-circle {
        width: 150px;
        height: 150px;
        font-size: 48px;
      }
      .score-text {
        font-size: 18px;
      }
      .result-verb {
        font-size: 16px;
      }
      .result-answers {
        font-size: 13px;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.4em;
      }
      h2 {
        font-size: 1.1em;
      }
      .stat-card {
        padding: 20px;
      }
      .stat-label {
        font-size: 11px;
      }
      .stat-value {
        font-size: 32px;
      }
      .mode-card {
        padding: 15px;
      }
      .mode-title {
        font-size: 18px;
      }
      .question-word {
        font-size: 24px;
      }
      .question-label {
        font-size: 14px;
      }
      .answer-input {
        font-size: 16px;
        padding: 12px;
      }
      .answer-inputs {
        gap: 15px;
      }
      .score-circle {
        width: 120px;
        height: 120px;
        font-size: 36px;
      }
      .dark-mode-toggle {
        top: 10px;
        right: 10px;
      }
      .back-button {
        top: 10px;
        left: 10px;
        padding: 8px 15px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="dark-mode-toggle">
    <label class="toggle-switch">
      <input type="checkbox" id="darkModeToggle">
      <span class="toggle-slider"></span>
    </label>
  </div>

  <a href="display.html" class="back-button">‚Üê Zur√ºck</a>

  <div class="container">
    <h1>Irregular Verbs Trainer</h1>

    <!-- Dashboard Screen mit integrierten √úbungs-Buttons -->
    <div id="dashboardScreen" class="screen active">
      <h2 style="text-align: center; margin-bottom: 30px;">üìä Deine Statistiken</h2>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Overall Accuracy</div>
          <div class="stat-value" id="overallAccuracy">--%</div>
        </div>

        <div class="stat-card">
          <div class="stat-label">Accuracy Simple Past</div>
          <div class="stat-value" id="simplePastAccuracy">--%</div>
        </div>

        <div class="stat-card">
          <div class="stat-label">Accuracy Past Participle</div>
          <div class="stat-value" id="pastParticipleAccuracy">--%</div>
        </div>
      </div>

      <h2 style="text-align: center; margin: 40px 0 20px 0;">üìù W√§hle deinen √úbungsmodus</h2>

      <div class="mode-selector">
        <div class="mode-card" onclick="startMode('simple')">
          <div class="mode-title">üìù Infinitive + Simple Past</div>
        </div>

        <div class="mode-card" onclick="startMode('full')">
          <div class="mode-title">üìö Alle drei Formen</div>
        </div>
      </div>

      <div style="text-align: center; margin-top: 40px;">
        <button onclick="window.location.href='display.html'">‚Üê Zur√ºck zum Hauptmen√º</button>
      </div>
    </div>
    <!-- Quiz Screen -->
    <div id="quizScreen" class="screen">
      <div class="quiz-header">
        <div class="progress" id="progress">Frage 1 von 20</div>
        <div class="timer" id="timer">15</div>
      </div>

      <div class="question-card">
        <div class="question-label">Deutsch:</div>
        <div class="question-word" id="questionWord">sein</div>
      </div>

      <div class="answer-inputs" id="answerInputs">
        <!-- Will be filled by JavaScript -->
      </div>

      <div id="feedback" class="feedback" style="display: none;"></div>

      <div style="text-align: center; margin-top: 30px;">
        <button onclick="checkAnswer()">Antwort pr√ºfen</button>
        <button onclick="skipQuestion()">√úberspringen</button>
      </div>
    </div>

    <!-- Results Screen -->
    <div id="resultsScreen" class="screen">
      <div class="score-display">
        <div class="score-circle" id="scoreCircle">0%</div>
        <div class="score-text">Dein Ergebnis</div>
        <div class="score-text" id="scoreDetails"></div>
      </div>

      <div class="results-list" id="resultsList"></div>

      <div style="text-align: center; margin-top: 30px;">
        <button onclick="restartQuiz()">Nochmal √ºben</button>
        <button onclick="window.location.href='display.html'">Zur√ºck zum Hauptmen√º</button>
      </div>
    </div>

    <div class="footer">From Simon with love ‚ù§Ô∏è</div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBRPlWh1slILKg8DWQDOEWXSFsnUK3j1vw",
      authDomain: "testdatabase-4daf4.firebaseapp.com",
      databaseURL: "https://testdatabase-4daf4-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "testdatabase-4daf4",
      storageBucket: "testdatabase-4daf4.firebasestorage.app",
      messagingSenderId: "743231387214",
      appId: "1:743231387214:web:166169b25f72616280351f"
    };

    // Initialize Firebase
    let app, db;
    let firebaseReady = false;

    try {
      app = firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      firebaseReady = true;
      console.log('‚úì Firebase initialized successfully');
    } catch (error) {
      console.error('‚ùå Firebase initialization error:', error);
      alert('Fehler beim Verbinden mit Firebase. Bitte Seite neu laden.');
    }

    // Global Variables
    let currentUser = null;
    let currentMode = null;
    let irregularVerbs = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let totalQuestions = 0;
    let results = [];
    let timerInterval = null;
    let timeLeft = 15;

    // Dark Mode
    const darkModeToggle = document.getElementById('darkModeToggle');
    const savedDarkMode = localStorage.getItem('lmg_darkMode') === 'true';
    if (savedDarkMode) {
      document.body.classList.add('dark-mode');
      darkModeToggle.checked = true;
    }

    darkModeToggle.addEventListener('change', function() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('lmg_darkMode', this.checked);
    });

    // Load User from localStorage
    function loadUser() {
      const userData = localStorage.getItem('lmg_currentUser');
      if (!userData) {
        alert('Bitte melde dich zuerst an!');
        window.location.href = 'index.html';
        return;
      }
      currentUser = JSON.parse(userData);
      console.log('User loaded:', currentUser);
    }

    // Load Irregular Verbs from JSON
    async function loadIrregularVerbs() {
      try {
        const jahrgang = currentUser.jahrgang || '6';
        let filename = 'irrverbs6.json';
        
        // Klasse 6 verwendet irrverbs6.json
        // Klasse 7-10 verwenden irrverbs7to10.json
        if (parseInt(jahrgang) >= 7) {
          filename = 'irrverbs7to10.json';
        }

        const url = `https://raw.githubusercontent.com/simon23-12/LMG.Vocab.Trainer/main/grammar/${filename}`;
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error('Failed to load irregular verbs');
        }

        irregularVerbs = await response.json();
        console.log(`Loaded ${irregularVerbs.length} irregular verbs from ${filename}`);
      } catch (error) {
        console.error('Error loading irregular verbs:', error);
        alert('Fehler beim Laden der Verben. Bitte versuche es sp√§ter erneut.');
      }
    }

    // Start Quiz with selected mode
    async function startMode(mode) {
      currentMode = mode;
      await loadIrregularVerbs();
      
      if (irregularVerbs.length === 0) {
        alert('Keine Verben gefunden!');
        return;
      }

      // Shuffle verbs and select 20 random ones
      const shuffled = irregularVerbs.sort(() => Math.random() - 0.5);
      irregularVerbs = shuffled.slice(0, 20);
      totalQuestions = irregularVerbs.length;

      currentQuestionIndex = 0;
      score = 0;
      results = [];

      showScreen('quizScreen');
      setupAnswerInputs();
      showQuestion();
      startTimer();
    }

    // Setup Answer Input Fields based on mode
    function setupAnswerInputs() {
      const answerInputsDiv = document.getElementById('answerInputs');
      
      if (currentMode === 'simple') {
        answerInputsDiv.innerHTML = `
          <div class="answer-input-group">
            <label class="answer-label">Infinitive:</label>
            <input type="text" id="infinitiveInput" class="answer-input" autocomplete="off" autofocus>
          </div>
          <div class="answer-input-group">
            <label class="answer-label">Simple Past:</label>
            <input type="text" id="simplePastInput" class="answer-input" autocomplete="off">
          </div>
        `;
      } else {
        answerInputsDiv.innerHTML = `
          <div class="answer-input-group">
            <label class="answer-label">Infinitive:</label>
            <input type="text" id="infinitiveInput" class="answer-input" autocomplete="off" autofocus>
          </div>
          <div class="answer-input-group">
            <label class="answer-label">Simple Past:</label>
            <input type="text" id="simplePastInput" class="answer-input" autocomplete="off">
          </div>
          <div class="answer-input-group">
            <label class="answer-label">Past Participle:</label>
            <input type="text" id="pastParticipleInput" class="answer-input" autocomplete="off">
          </div>
        `;
      }

      // Add Enter key listener
      const inputs = answerInputsDiv.querySelectorAll('.answer-input');
      inputs.forEach((input, index) => {
        input.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            if (index < inputs.length - 1) {
              // Move to next input
              inputs[index + 1].focus();
            } else {
              // Last input - check answer
              checkAnswer();
            }
          }
        });
      });
    }

    // Show Question
    function showQuestion() {
      if (currentQuestionIndex >= totalQuestions) {
        showResults();
        return;
      }

      const verb = irregularVerbs[currentQuestionIndex];
      document.getElementById('questionWord').textContent = verb.german;
      document.getElementById('progress').textContent = `Frage ${currentQuestionIndex + 1} von ${totalQuestions}`;

      // Clear inputs
      document.getElementById('infinitiveInput').value = '';
      document.getElementById('simplePastInput').value = '';
      if (currentMode === 'full') {
        document.getElementById('pastParticipleInput').value = '';
      }

      // Hide feedback
      document.getElementById('feedback').style.display = 'none';

      // Focus first input
      setTimeout(() => {
        document.getElementById('infinitiveInput').focus();
      }, 100);

      // Reset timer
      resetTimer();
    }

    // Timer Functions
    function startTimer() {
      // Timer basierend auf Modus: Simple = 15 Sekunden, Full = 20 Sekunden
      timeLeft = currentMode === 'simple' ? 15 : 20;
      updateTimerDisplay();
      
      // Clear any existing interval first
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();

        if (timeLeft <= 5) {
          document.getElementById('timer').classList.add('warning');
        }

        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          timerInterval = null;
          handleTimeout();
        }
      }, 1000);
    }

    function resetTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      document.getElementById('timer').classList.remove('warning');
      startTimer();
    }

    function updateTimerDisplay() {
      document.getElementById('timer').textContent = timeLeft;
    }

    function handleTimeout() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      const verb = irregularVerbs[currentQuestionIndex];
      
      results.push({
        german: verb.german,
        correct: false,
        infinitiveCorrect: false,
        simplePastCorrect: false,
        pastParticipleCorrect: currentMode === 'simple' ? null : false,
        userInfinitive: '(Timeout)',
        userSimplePast: '(Timeout)',
        userPastParticiple: currentMode === 'full' ? '(Timeout)' : null,
        correctInfinitive: verb.infinitive,
        correctSimplePast: verb.simple_past,
        correctPastParticiple: verb.past_participle
      });

      showFeedback(false, verb);
      
      setTimeout(() => {
        currentQuestionIndex++;
        showQuestion();
      }, 2000);
    }

    // Check Answer
    function checkAnswer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }

      const verb = irregularVerbs[currentQuestionIndex];
      const userInfinitive = document.getElementById('infinitiveInput').value.trim().toLowerCase();
      const userSimplePast = document.getElementById('simplePastInput').value.trim().toLowerCase();
      let userPastParticiple = null;
      
      if (currentMode === 'full') {
        userPastParticiple = document.getElementById('pastParticipleInput').value.trim().toLowerCase();
      }

      // Normalize correct answers
      const correctInfinitive = normalizeAnswer(verb.infinitive);
      const correctSimplePast = normalizeAnswer(verb.simple_past);
      const correctPastParticiple = currentMode === 'full' ? normalizeAnswer(verb.past_participle) : null;

      // Check each form separately
      const infinitiveCorrect = checkVerbForm(userInfinitive, correctInfinitive);
      const simplePastCorrect = checkVerbForm(userSimplePast, correctSimplePast);
      const pastParticipleCorrect = currentMode === 'simple' ? null : checkVerbForm(userPastParticiple, correctPastParticiple);

      // Overall correct if all required forms are correct
      const isCorrect = infinitiveCorrect && simplePastCorrect && (currentMode === 'simple' || pastParticipleCorrect);

      if (isCorrect) {
        score++;
      }

      results.push({
        german: verb.german,
        correct: isCorrect,
        infinitiveCorrect: infinitiveCorrect,
        simplePastCorrect: simplePastCorrect,
        pastParticipleCorrect: pastParticipleCorrect,
        userInfinitive: userInfinitive || '(leer)',
        userSimplePast: userSimplePast || '(leer)',
        userPastParticiple: userPastParticiple || (currentMode === 'full' ? '(leer)' : null),
        correctInfinitive: verb.infinitive,
        correctSimplePast: verb.simple_past,
        correctPastParticiple: verb.past_participle
      });

      showFeedback(isCorrect, verb, infinitiveCorrect, simplePastCorrect, pastParticipleCorrect);

      setTimeout(() => {
        currentQuestionIndex++;
        showQuestion();
      }, 2500);
    }

    // Normalize Answer
    function normalizeAnswer(answer) {
      return answer.toLowerCase()
        .replace(/\(to\)\s*/g, '')
        .replace(/^to\s+/g, '')
        .trim();
    }

    // Check Verb Form (handle multiple variations separated by semicolon)
    function checkVerbForm(userAnswer, correctAnswer) {
      if (!userAnswer) return false;

      // Split by semicolon or slash for variations
      const variations = correctAnswer.split(/[;\/]/).map(v => v.trim().toLowerCase());
      const userNormalized = userAnswer.toLowerCase().trim();

      return variations.some(variation => {
        return variation === userNormalized || 
               variation.replace(/\s+/g, '') === userNormalized.replace(/\s+/g, '');
      });
    }

    // Show Feedback
    function showFeedback(isCorrect, verb, infinitiveCorrect, simplePastCorrect, pastParticipleCorrect) {
      const feedbackDiv = document.getElementById('feedback');
      feedbackDiv.style.display = 'block';

      if (isCorrect) {
        feedbackDiv.className = 'feedback correct';
        feedbackDiv.textContent = '‚úì Alles richtig!';
      } else {
        feedbackDiv.className = 'feedback wrong';
        let wrongParts = [];
        
        if (!infinitiveCorrect) wrongParts.push(`Infinitive: ${verb.infinitive}`);
        if (!simplePastCorrect) wrongParts.push(`Simple Past: ${verb.simple_past}`);
        if (currentMode === 'full' && !pastParticipleCorrect) wrongParts.push(`Past Participle: ${verb.past_participle}`);
        
        feedbackDiv.textContent = '‚úó Falsch! Richtig: ' + wrongParts.join(' | ');
      }
    }

    // Skip Question
    function skipQuestion() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      
      const verb = irregularVerbs[currentQuestionIndex];
      results.push({
        german: verb.german,
        correct: false,
        infinitiveCorrect: false,
        simplePastCorrect: false,
        pastParticipleCorrect: currentMode === 'simple' ? null : false,
        userInfinitive: '(√ºbersprungen)',
        userSimplePast: '(√ºbersprungen)',
        userPastParticiple: currentMode === 'full' ? '(√ºbersprungen)' : null,
        correctInfinitive: verb.infinitive,
        correctSimplePast: verb.simple_past,
        correctPastParticiple: verb.past_participle
      });

      currentQuestionIndex++;
      showQuestion();
    }

    // Show Results
    function showResults() {
      clearInterval(timerInterval);
      
      const percent = Math.round((score / totalQuestions) * 100);
      
      // Calculate accuracy per form
      let infinitiveCorrectCount = 0;
      let simplePastCorrectCount = 0;
      let pastParticipleCorrectCount = 0;
      let pastParticipleTotal = 0;

      results.forEach(result => {
        if (result.infinitiveCorrect) infinitiveCorrectCount++;
        if (result.simplePastCorrect) simplePastCorrectCount++;
        if (result.pastParticipleCorrect !== null) {
          pastParticipleTotal++;
          if (result.pastParticipleCorrect) pastParticipleCorrectCount++;
        }
      });

      const infinitiveAccuracy = Math.round((infinitiveCorrectCount / totalQuestions) * 100);
      const simplePastAccuracy = Math.round((simplePastCorrectCount / totalQuestions) * 100);
      const pastParticipleAccuracy = pastParticipleTotal > 0 ? Math.round((pastParticipleCorrectCount / pastParticipleTotal) * 100) : null;

      document.getElementById('scoreCircle').textContent = percent + '%';
      document.getElementById('scoreDetails').innerHTML = `
        ${score} von ${totalQuestions} komplett richtig<br>
        <span style="font-size: 16px; margin-top: 10px; display: block;">
          Infinitive: ${infinitiveAccuracy}% | Simple Past: ${simplePastAccuracy}%${pastParticipleAccuracy !== null ? ` | Past Participle: ${pastParticipleAccuracy}%` : ''}
        </span>
      `;

      // Build results list
      const resultsList = document.getElementById('resultsList');
      resultsList.innerHTML = '<h2 style="text-align: center; margin-bottom: 20px;">Deine Antworten:</h2>';

      results.forEach(result => {
        const itemDiv = document.createElement('div');
        itemDiv.className = `result-item ${result.correct ? 'correct' : 'wrong'}`;
        
        let answersHTML = `
          <div class="result-verb">${result.german}</div>
          <div class="result-answers">
            <div style="${result.infinitiveCorrect ? 'color: #155724;' : 'color: #721c24;'}">
              Infinitive: ${result.userInfinitive} ${!result.infinitiveCorrect ? `‚Üí ${result.correctInfinitive}` : '‚úì'}
            </div>
            <div style="${result.simplePastCorrect ? 'color: #155724;' : 'color: #721c24;'}">
              Simple Past: ${result.userSimplePast} ${!result.simplePastCorrect ? `‚Üí ${result.correctSimplePast}` : '‚úì'}
            </div>
            ${currentMode === 'full' ? `
              <div style="${result.pastParticipleCorrect ? 'color: #155724;' : 'color: #721c24;'}">
                Past Participle: ${result.userPastParticiple} ${!result.pastParticipleCorrect ? `‚Üí ${result.correctPastParticiple}` : '‚úì'}
              </div>
            ` : ''}
          </div>
        `;
        
        itemDiv.innerHTML = answersHTML;
        resultsList.appendChild(itemDiv);
      });

      // Save to Firebase with detailed stats
      saveResultsToFirebase(percent, infinitiveAccuracy, simplePastAccuracy, pastParticipleAccuracy);

      showScreen('resultsScreen');
    }

    // Save Results to Firebase
    async function saveResultsToFirebase(percent, infinitiveAccuracy, simplePastAccuracy, pastParticipleAccuracy) {
      if (!firebaseReady) {
        console.error('Firebase not ready, cannot save results');
        alert('Fehler: Firebase-Verbindung nicht bereit. Ergebnisse konnten nicht gespeichert werden.');
        return;
      }

      try {
        console.log('=== Saving Results to Firebase ===');
        console.log('UserKey:', currentUser.userKey);
        
        const resultData = {
          percent: percent,
          score: score,
          total: totalQuestions,
          mode: currentMode,
          infinitiveAccuracy: infinitiveAccuracy,
          simplePastAccuracy: simplePastAccuracy,
          pastParticipleAccuracy: pastParticipleAccuracy,
          timestamp: new Date().toISOString(),
          date: new Date().toLocaleDateString('de-DE')
        };

        console.log('Result Data:', resultData);

        const key = currentMode === 'simple' ? 'irregularVerbsSimple' : 'irregularVerbsFull';
        const path = `users/${currentUser.userKey}/${key}`;
        
        console.log('Saving to path:', path);
        
        await db.ref(path).set(resultData);
        console.log('‚úì Results saved to Firebase successfully');

        // Update dashboard stats
        await updateDashboardStats();
      } catch (error) {
        console.error('‚ùå Error saving to Firebase:', error);
        alert('Fehler beim Speichern der Ergebnisse: ' + error.message);
      }
    }

    // Restart Quiz
    function restartQuiz() {
      showScreen('dashboardScreen');
      loadDashboardStats();
    }

    // Show Screen
    function showScreen(screenId) {
      const screens = document.querySelectorAll('.screen');
      screens.forEach(screen => screen.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    // Load Dashboard Stats
    async function loadDashboardStats() {
      if (!firebaseReady) {
        console.warn('Firebase not ready, cannot load dashboard stats');
        setDefaultStats();
        return;
      }

      try {
        console.log('=== Loading Dashboard Stats ===');
        console.log('UserKey:', currentUser.userKey);
        
        const userRef = db.ref(`users/${currentUser.userKey}`);
        const snapshot = await userRef.once('value');
        const userData = snapshot.val();

        console.log('User Data from Firebase:', userData);

        if (!userData) {
          console.log('No user data found, setting defaults');
          setDefaultStats();
          return;
        }

        const simpleData = userData.irregularVerbsSimple;
        const fullData = userData.irregularVerbsFull;

        console.log('Simple Mode Data:', simpleData);
        console.log('Full Mode Data:', fullData);

        let overallAccuracy = '--';
        let simplePastAccuracy = '--';
        let pastParticipleAccuracy = '--';

        // Calculate overall accuracy from both modes
        if (simpleData && fullData) {
          overallAccuracy = Math.round((simpleData.percent + fullData.percent) / 2);
        } else if (simpleData) {
          overallAccuracy = simpleData.percent;
        } else if (fullData) {
          overallAccuracy = fullData.percent;
        }

        // Calculate Simple Past accuracy
        const simplePastScores = [];
        if (simpleData && simpleData.simplePastAccuracy !== undefined) {
          simplePastScores.push(simpleData.simplePastAccuracy);
        }
        if (fullData && fullData.simplePastAccuracy !== undefined) {
          simplePastScores.push(fullData.simplePastAccuracy);
        }
        if (simplePastScores.length > 0) {
          simplePastAccuracy = Math.round(simplePastScores.reduce((a, b) => a + b, 0) / simplePastScores.length);
        }

        // Calculate Past Participle accuracy (only from full mode)
        if (fullData && fullData.pastParticipleAccuracy !== undefined && fullData.pastParticipleAccuracy !== null) {
          pastParticipleAccuracy = fullData.pastParticipleAccuracy;
        }

        console.log('Calculated Stats:');
        console.log('- Overall Accuracy:', overallAccuracy);
        console.log('- Simple Past Accuracy:', simplePastAccuracy);
        console.log('- Past Participle Accuracy:', pastParticipleAccuracy);

        // Update dashboard
        document.getElementById('overallAccuracy').textContent = overallAccuracy !== '--' ? overallAccuracy + '%' : '--%';
        document.getElementById('simplePastAccuracy').textContent = simplePastAccuracy !== '--' ? simplePastAccuracy + '%' : '--%';
        document.getElementById('pastParticipleAccuracy').textContent = pastParticipleAccuracy !== '--' ? pastParticipleAccuracy + '%' : '--%';

        console.log('=== Dashboard Stats Updated ===');

      } catch (error) {
        console.error('Error loading dashboard stats:', error);
        setDefaultStats();
      }
    }

    function setDefaultStats() {
      document.getElementById('overallAccuracy').textContent = '--%';
      document.getElementById('simplePastAccuracy').textContent = '--%';
      document.getElementById('pastParticipleAccuracy').textContent = '--%';
    }

    // Update Dashboard Stats after saving results
    async function updateDashboardStats() {
      await loadDashboardStats();
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', function() {
      loadUser();
      loadDashboardStats();
    });
  </script>
  
  <!-- PWA Installation Script -->
  <script src="/pwa-install.js"></script>
</body>
</html>
